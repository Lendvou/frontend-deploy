(this["webpackJsonpcallmaster-frontend"]=this["webpackJsonpcallmaster-frontend"]||[]).push([[0],{283:function(e,t){},366:function(e,t){function r(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=366},368:function(e,t,r){},369:function(e,t,r){"use strict";r.r(t);var a=r(1),n=r(0),c=r(23),s=r.n(c),i=r(7),o=r.n(i),u=r(14),l=r(27),d=r(109),j=r.n(d),h=r(73),b=r(17),f=r(24),m=r(212),p=r(98),v=r(87),O=r(184),x=r(49),_=Object(v.b)({name:"core",initialState:{peer:{}},reducers:{setPeer:function(e,t){var r=t.payload;e.peer=r}}}),g=_.actions.setPeer,w=_.reducer,N={token:"",isAuth:!1,user:{}},k=Object(v.b)({name:"user",initialState:N,reducers:{setAuthData:function(e,t){return t.payload},resetAuthData:function(){return N},setUser:function(e,t){var r=t.payload;e.user=r}}}),y=k.actions,C=y.setAuthData,T=y.resetAuthData,A=y.setUser,S=k.reducer,E=Object(x.b)({core:w,user:S}),M=(Object(O.createLogger)({collapsed:!0,colors:{title:function(){return"#6FB3D2"},prevState:function(){return"#9E9E9E"},action:function(){return"#03A9F4"},nextState:function(){return"#4CAF50"},error:function(){return"#F20404"}}}),Object(v.a)({reducer:E,middleware:function(e){return e({serializableCheck:{ignoredActions:["core/setPeer"]}})}})),I=p.c,D=p.b,L=M,H=function(e){var t=e.isProtected,r=void 0!==t&&t,n=e.allowedRoles,c=e.layout,s=Object(m.a)(e,["isProtected","allowedRoles","layout"]),i=I((function(e){return e.user})),o=i.user,u=i.isAuth;return r&&!u?Object(a.jsx)(b.a,{to:"/login"}):n&&!n.includes(o.role)?Object(a.jsx)(b.a,{to:"/404"}):c?Object(a.jsx)(c,{children:Object(a.jsx)(b.b,Object(f.a)({},s))}):Object(a.jsx)(b.b,Object(f.a)({},s))},$=r(377),F=r(378),R=r(379),U=r(380),P=r(381),z=r(213),q=r(376),B=r(373),Y=r(110),J=r.n(Y),V=r(185),W=r.n(V),Z=r(186),K=r.n(Z),G=r(187),Q=r.n(G),X=r(188),ee=r.n(X),te=Q()("http://3.67.189.159",{transports:["polling"],path:"/api/socket.io"}),re=W()().configure(K()(te)).configure(ee()({storageKey:"token"})),ae=function(e){return function(){var t=Object(u.a)(o.a.mark((function t(r){var a,n,c;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,re.authenticate({email:e.email,password:e.password,strategy:"local"});case 2:a=t.sent,n=a.accessToken,c=a.user,r(C({isAuth:!0,token:n,user:c}));case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},ne=function(e){return function(){var t=Object(u.a)(o.a.mark((function t(r,a){var n,c;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=a().user.user,t.next=3,re.service("users").patch(n,e);case 3:return c=t.sent,r(A(c)),t.abrupt("return",c);case 6:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}()},ce=function(e){var t,r,c=e.children,s=Object(b.g)(),i=D(),d=I((function(e){return e.user})),j=d.user,h=d.token,f=Object(n.useState)(!1),m=Object(l.a)(f,2),p=m[0],v=m[1],O=function(e){v(!1),s.push(e)},x=function(){var e=Object(u.a)(o.a.mark((function e(t){var r,a,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.target.files[0],(a=new FormData).append("file",r),e.prev=3,e.next=6,J()({method:"post",url:"http://3.67.189.159/api/uploads",data:a,headers:{Authorization:"Bearer ".concat(h)}});case 6:return n=e.sent.data[0],e.next=9,i(ne({avatarId:n._id}));case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(3),console.error("Error while uploading avatar",e.t0);case 14:case"end":return e.stop()}}),e,null,[[3,11]])})));return function(t){return e.apply(this,arguments)}}(),_=function(){var e=Object(u.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i(function(){var e=Object(u.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,re.logout();case 2:t(T());case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:s.push("/login"),e.next=10;break;case 6:e.prev=6,e.t0=e.catch(0),z.b.error("\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0440\u0430\u0437\u043b\u043e\u0433\u0438\u043d\u0438\u0442\u044c\u0441\u044f",4),console.error("Error while unlogging",e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(){return e.apply(this,arguments)}}();return Object(n.useEffect)((function(){"1"===localStorage.getItem("darkMode")?document.body.classList.add("dark"):document.body.classList.remove("dark")}),[]),Object(a.jsxs)("div",{className:"main",children:[Object(a.jsx)($.a,{className:"main__settings-icon",onClick:function(){return v(!0)}}),Object(a.jsxs)(q.a,{className:"drawer",title:"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438",placement:"right",closable:!1,onClose:function(){return v(!1)},visible:p,width:"15%",children:[Object(a.jsxs)("div",{style:{width:"100%"},children:[Object(a.jsxs)("div",{className:"drawer__user-info",children:[Object(a.jsx)("div",{onClick:function(){return function(){var e=document.createElement("input");e.type="file",e.onchange=x,e.click()}()},children:Object(a.jsx)(B.a,{src:null===(r=j.avatar)||void 0===r?void 0:r.path,icon:Object(a.jsx)(F.a,{}),size:128},null===(t=j.avatar)||void 0===t?void 0:t.path)}),Object(a.jsxs)("div",{className:"drawer__user-name",children:[j.firstName," ",j.lastName]})]}),"admin"===j.role?Object(a.jsxs)("div",{className:"drawer__list",children:[Object(a.jsxs)("div",{onClick:function(){return O("/chat")},className:"drawer__list-item",children:[Object(a.jsx)(R.a,{}),"\u0427\u0430\u0442"]}),Object(a.jsxs)("div",{onClick:function(){return O("/admin")},className:"drawer__list-item",children:[Object(a.jsx)(R.a,{}),"\u0410\u0434\u043c\u0438\u043d \u043f\u0430\u043d\u0435\u043b\u044c"]})]}):Object(a.jsx)("div",{})]}),Object(a.jsxs)("div",{className:"drawer__bottom",children:[Object(a.jsx)("div",{className:"drawer__color-mode",children:Object(a.jsx)(U.a,{onClick:function(){"1"===localStorage.getItem("darkMode")?(document.body.classList.remove("dark"),localStorage.setItem("darkMode","0")):(document.body.classList.add("dark"),localStorage.setItem("darkMode","1"))}})}),Object(a.jsxs)("div",{className:"drawer__logout",children:["\u0412\u044b\u0439\u0442\u0438",Object(a.jsx)(P.a,{className:"drawer__logout",onClick:_})]})]})]}),c]})},se=function(e){var t=e.children;return Object(a.jsx)("div",{className:"auth-layout",children:Object(a.jsx)("div",{className:"auth-layout__container",children:t})})},ie=r(34),oe=r(55),ue=r(375),le=r(54),de=r(64),je=r(47),he=function(e){var t=e.meta,r=e.errorText,n=e.children;return Object(a.jsxs)("div",{className:Object(je.a)("field-with-validation",{"field-with-validation--invalid":t.error&&t.touched}),children:[r&&t.error&&t.touched&&Object(a.jsx)("span",{className:"field-with-validation__error-text",children:r}),n]})},be=function(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())},fe=function(e){return"client"===e.role?"operator":"client"},me=function(e){return e.role+"UnreadMessages"},pe=function(e){var t={};return e.email||(t.email="\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0435 \u043f\u043e\u043b\u0435"),e.email&&!be(e.email)&&(t.email="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 email \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e"),(!e.password||e.password.trim().length<3)&&(t.password="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 6 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432"),e.firstName||(t.firstName="\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0435 \u043f\u043e\u043b\u0435"),e.lastName||(t.lastName="\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0435 \u043f\u043e\u043b\u0435"),t},ve=function(e){var t=e.title,r=void 0===t?"\u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f":t,c=e.isFromAdmin,s=void 0!==c&&c,i=Object(b.g)(),d=Object(n.useState)("client"),j=Object(l.a)(d,2),m=j[0],p=j[1],v=function(){var e=Object(u.a)(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={email:t.email,password:t.password,firstName:t.firstName,lastName:t.lastName,role:m},e.prev=1,e.next=4,re.service("users").create(r);case 4:z.b.success("\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u0441\u043e\u0437\u0434\u0430\u043d"),s||i.push("/login"),e.next=12;break;case 8:return e.prev=8,e.t0=e.catch(1),console.error("signup err",e.t0),e.abrupt("return",Object(ie.a)({},de.a,e.t0.message));case 12:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(t){return e.apply(this,arguments)}}();return Object(a.jsx)(oe.b,{onSubmit:v,validate:pe,render:function(e){var t=e.handleSubmit,n=e.submitError,c=e.submitting;return Object(a.jsxs)("form",{className:"auth-form auth-form--signup",onSubmit:t,children:[Object(a.jsx)("div",{className:"auth-form__title",children:r}),n&&Object(a.jsx)("div",{className:"auth-form__error",children:n}),s&&Object(a.jsxs)("div",{className:"auth-form__role",children:[Object(a.jsx)("div",{className:Object(je.a)("auth-form__role-item",{"auth-form__role-item--active":"client"===m}),onClick:function(){return p("client")},children:"\u041a\u043b\u0438\u0435\u043d\u0442"}),Object(a.jsx)("div",{className:Object(je.a)("auth-form__role-item",{"auth-form__role-item--active":"operator"===m}),onClick:function(){return p("operator")},children:"\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440"}),Object(a.jsx)("div",{className:Object(je.a)("auth-form__role-item",{"auth-form__role-item--active":"admin"===m}),onClick:function(){return p("admin")},children:"\u0410\u0434\u043c\u0438\u043d"})]}),Object(a.jsxs)("div",{className:"auth-form__fields",children:[Object(a.jsx)(oe.a,{name:"firstName",children:function(e){var t=e.input,r=e.meta;return Object(a.jsx)(he,{meta:r,errorText:r.error,children:Object(a.jsx)(ue.a,Object(f.a)(Object(f.a)({},t),{},{placeholder:"\u0418\u043c\u044f"}))})}}),Object(a.jsx)(oe.a,{name:"lastName",children:function(e){var t=e.input,r=e.meta;return Object(a.jsx)(he,{meta:r,errorText:r.error,children:Object(a.jsx)(ue.a,Object(f.a)(Object(f.a)({},t),{},{placeholder:"\u0424\u0430\u043c\u0438\u043b\u0438\u044f"}))})}}),Object(a.jsx)(oe.a,{name:"email",children:function(e){var t=e.input,r=e.meta;return Object(a.jsx)(he,{meta:r,errorText:r.error,children:Object(a.jsx)(ue.a,Object(f.a)(Object(f.a)({},t),{},{placeholder:"Email"}))})}}),Object(a.jsx)(oe.a,{name:"password",children:function(e){var t=e.input,r=e.meta;return Object(a.jsx)(he,{meta:r,errorText:r.error,children:Object(a.jsx)(ue.a.Password,Object(f.a)(Object(f.a)({},t),{},{placeholder:"\u041f\u0430\u0440\u043e\u043b\u044c"}))})}})]}),Object(a.jsx)(le.a,{className:"auth-form__button",type:"primary",htmlType:"submit",loading:c,children:s?"\u0414\u043e\u0431\u0430\u0432\u0438\u0442\u044c":"\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c\u0441\u044f"}),!s&&Object(a.jsxs)("div",{className:"auth-form__footer-text",children:["\u0415\u0441\u0442\u044c \u0430\u043a\u043a\u0430\u0443\u043d\u0442? ",Object(a.jsx)(h.b,{to:"/login",children:"\u0412\u043e\u0439\u0442\u0438"})]})]})}})},Oe=function(){return Object(a.jsxs)("div",{className:"admin",children:[Object(a.jsx)("h2",{className:"admin__title",children:"Wellcum to the admin page"}),Object(a.jsx)("div",{className:"admin__signup",children:Object(a.jsx)(ve,{title:"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f",isFromAdmin:!0})})]})},xe=r(117),_e=r(197),ge=r.n(_e),we=r(374),Ne=r(140),ke=r.n(Ne),ye=r(68),Ce=r.n(ye),Te=r(198),Ae=function(e){var t,r=e.chats,c=e.activeChat,s=e.setChats,i=e.onChatClick,d=I((function(e){return e.user.user})),h=Object(n.useState)(!0),b=Object(l.a)(h,2),f=b[0],m=b[1],p=Object(n.useState)(""),v=Object(l.a)(p,2),O=v[0],x=v[1],_=Object(n.useMemo)((function(){return O?r.filter((function(e){var t,r,a=e[fe(d)];return(null===a||void 0===a||null===(t=a.firstName)||void 0===t?void 0:t.toLowerCase().includes(O.toLowerCase()))||(null===a||void 0===a||null===(r=a.lastName)||void 0===r?void 0:r.toLowerCase().includes(O.toLowerCase()))})).sort((function(e,t){return new Date(t.lastMessageDate).getTime()-new Date(e.lastMessageDate).getTime()})):r}),[O,r,d]),g=function(e){return e[d.role+"UnreadMessages"]},w=function(){var e=Object(u.a)(o.a.mark((function e(){var t,a,n,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a="client"===d.role?"clientId":"operatorId",e.next=3,re.service("chats").find({query:(t={},Object(ie.a)(t,a,d._id),Object(ie.a)(t,"$limit",15),Object(ie.a)(t,"$skip",r.length),Object(ie.a)(t,"$search",O||void 0),Object(ie.a)(t,"$sort",{lastMessageDate:-1}),t)});case 3:n=e.sent,c=r.concat(n.data),s(c),c.length>=n.total&&m(!1);case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return Object(n.useEffect)((function(){(function(){var e=Object(u.a)(o.a.mark((function e(){var t,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="client"===d.role?"clientId":"operatorId",e.next=3,re.service("chats").find({query:(t={},Object(ie.a)(t,r,d._id),Object(ie.a)(t,"$limit",15),Object(ie.a)(t,"$skip",0),Object(ie.a)(t,"$sort",{lastMessageDate:-1}),t)});case 3:a=e.sent,console.log("chats",a),s(a.data);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()()}),[]),Object(a.jsxs)("div",{className:"chat__side",children:[Object(a.jsxs)("div",{className:"chat__side-search",children:[Object(a.jsx)(ke.a,{src:null===(t=d.avatar)||void 0===t?void 0:t.path,icon:Object(a.jsx)(F.a,{})}),Object(a.jsx)(ue.a,{placeholder:"\u041f\u043e\u0438\u0441\u043a",value:O,onChange:function(e){return x(e.target.value)}})]}),Object(a.jsx)("h2",{className:"chat__title",children:"\u0427\u0430\u0442\u044b"}),Object(a.jsx)("div",{className:"chat__side-items",id:"scrollableContainer",children:Object(a.jsx)(Te.a,{dataLength:r.length,next:w,hasMore:f,loader:0===r.length?Object(a.jsx)("span",{}):Object(a.jsx)(j.a,{type:"bars",color:"#69C262",width:"40px",className:"loading-center"}),scrollableTarget:"scrollableContainer",children:_.map((function(e){var t,r,n,s,o,u,l;return Object(a.jsxs)("div",{className:Object(je.a)("chat__box",{"chat__box--active":e._id===c._id}),onClick:function(){return i(e)},children:[Object(a.jsx)("div",{className:"chat__box__left",children:Object(a.jsx)(ke.a,{src:null===(t=e[fe(d)])||void 0===t||null===(r=t.avatar)||void 0===r?void 0:r.path,icon:Object(a.jsx)(F.a,{})})}),Object(a.jsxs)("div",{className:"chat__box__center",children:[Object(a.jsxs)("div",{className:"chat__box__name",children:["\u041a\u043b\u0438\u0435\u043d\u0442 ",(null===(n=e.client)||void 0===n?void 0:n.num)||"-"]}),Object(a.jsxs)("div",{className:"chat__box__last-message",children:[(null===(s=e.lastMessage)||void 0===s?void 0:s.userId)===d._id&&Object(a.jsx)("span",{children:"\u0412\u044b:"}),"text"===(null===(o=e.lastMessage)||void 0===o?void 0:o.type)&&(null===(u=e.lastMessage)||void 0===u?void 0:u.text),"photo"===(null===(l=e.lastMessage)||void 0===l?void 0:l.type)&&"\ud83d\udce5 Photo"]})]}),Object(a.jsxs)("div",{className:"chat__box__right",children:[Object(a.jsx)("div",{className:"chat__box__time",children:e.lastMessageDate?Ce()(e.lastMessageDate).format("HH:mm"):""}),!!g(e)&&Object(a.jsx)("div",{className:"chat__box__messages-count",children:g(e)})]})]},e._id)}))})})]})},Se=r(371),Ee=r(384),Me=r(385),Ie=r(386),De=r(372),Le=r(382),He=function(e){var t=e.isVisible,r=e.onClose,c=e.onOk,s=I((function(e){return e.user.token})),i=Object(n.useState)([]),d=Object(l.a)(i,2),j=d[0],h=d[1],b=Object(n.useMemo)((function(){return j.map((function(e){return{uid:e._id,name:e.filename,size:50,type:e.mimetype,url:e.path}}))}),[j]),f=function(){var e=Object(u.a)(o.a.mark((function e(t){var r,a,n,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("args",t),r=t.file,(a=new FormData).append("file",r),(n=new FileReader).readAsDataURL(r),n.onload=function(e){var t=new Image;t.src=e.target.result,t.onload=function(){var e=this.height,t=this.width;console.log("height withd",t,e)}},e.prev=7,e.next=10,J()({method:"post",url:"http://3.67.189.159/api/uploads",data:a,headers:{Authorization:"Bearer ".concat(s)}});case 10:c=e.sent.data[0],h((function(e){return[].concat(Object(xe.a)(e),[c])})),console.log("resp",c),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(7),console.error("error in uploading",e.t0);case 18:case"end":return e.stop()}}),e,null,[[7,15]])})));return function(t){return e.apply(this,arguments)}}(),m=function(){h([]),c(j)};return Object(a.jsx)(we.a,{visible:t,onCancel:function(){h([]),r()},onOk:function(){return m()},okText:"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c",cancelText:"\u041e\u0442\u043c\u0435\u043d\u0438\u0442\u044c",centered:!0,destroyOnClose:!0,children:Object(a.jsx)(De.a,{customRequest:f,listType:"picture-card",fileList:b,onChange:function(e){return console.log("file",e)},children:j.length>=4?null:Object(a.jsxs)("div",{children:[Object(a.jsx)(Le.a,{}),Object(a.jsx)("div",{style:{marginTop:8},children:"\u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c"})]})})})},$e=r(383),Fe=function(e){var t=e.message,r=I((function(e){return e.user.user}));return Object(a.jsx)("div",{className:Object(je.a)("chat-message",{"chat-message--yours":t.userId===r._id,"chat-message--his":t.userId!==r._id}),children:Object(a.jsxs)("div",{className:"chat-message__wrapper",children:["text"===t.type&&Object(a.jsx)("div",{className:"chat-message__text",children:t.text}),"photo"===t.type&&Object(a.jsx)("div",{className:"chat-message__photo",children:t.photos.map((function(e){return Object(a.jsx)("img",{src:e.path,alt:"tut doljno bit foto"},e._id)}))}),Object(a.jsxs)("div",{className:"chat-message__info",children:[Object(a.jsx)("div",{className:"chat-message__time",children:Ce()(t.createdAt).format("HH:mm")}),Object(a.jsx)("div",{className:"chat-message__received",children:t.isRead?Object(a.jsxs)("div",{className:"chat-message__received-double",children:[Object(a.jsx)($e.a,{}),Object(a.jsx)($e.a,{})]}):Object(a.jsx)($e.a,{})})]})]})})},Re=function(e){var t,r,c,s=e.activeChat,i=e.onCallUser,d=(e.isCallActive,e.currentCall),j=Object(n.useRef)(null),h=Object(n.useRef)(null),b=Object(n.useRef)(null),f=I((function(e){return e.user.user})),m=Object(n.useState)(!1),p=Object(l.a)(m,2),v=p[0],O=p[1],x=Object(n.useState)([]),_=Object(l.a)(x,2),g=_[0],w=_[1],N=Object(n.useState)(""),k=Object(l.a)(N,2),y=k[0],C=k[1],T=Object(n.useState)(!1),A=Object(l.a)(T,2),S=A[0],E=A[1],M=function(){var e=Object(u.a)(o.a.mark((function e(){var t,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={chatId:s._id,$limit:20,$skip:g.length,$sort:{createdAt:-1},$read:!0},e.next=3,re.service("messages").find({query:t});case 3:r=e.sent,a=r.data.reverse().concat(g),w(a),a.length>=r.total&&E(!1);case 7:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),D=function(){var e=Object(u.a)(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(y){e.next=2;break}return e.abrupt("return");case 2:return t={text:y,authorRole:f.role,chatId:s._id,userId:f._id,type:"text"},e.next=5,re.service("messages").create(t);case 5:C("");case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),L=function(){var e=Object(u.a)(o.a.mark((function e(t){var r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.target,!S||0!==r.scrollTop){e.next=6;break}return a=r.scrollHeight,e.next=5,M();case 5:r.scrollTop=r.scrollHeight-a;case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),H=function(e,t){return!!g[t+1]&&!Ce()(g[t+1].createdAt).isSame(Ce()(e.createdAt),"day")},$=function(){var e=Object(u.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,re.service("messages").create({type:"photo",photosIds:t.map((function(e){return e._id})),authorRole:f.role,chatId:s._id,userId:f._id});case 3:O(!1),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),console.error("photo error",e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}();return Object(n.useEffect)((function(){return re.service("messages").on("created",(function(e){console.log("receive messsssssss",e),s._id&&function(e){var t=h.current,r=t.scrollTop+t.clientHeight===t.scrollHeight,a=g.concat(e);w(a),(f._id===e.userId||r)&&(t.scrollTop=t.scrollHeight)}(e)})),function(){re.service("messages").removeListener("created")}}),[g,s]),Object(n.useEffect)((function(){(null===s||void 0===s?void 0:s._id)&&function(){var e=Object(u.a)(o.a.mark((function e(){var t,r,a,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={chatId:s._id,$limit:20,$skip:0,$sort:{createdAt:-1},$read:!0},e.next=3,re.service("messages").find({query:r});case 3:a=e.sent,console.info("messages",a),n=a.data.reverse(),w(n),E(!0),null===(t=j.current)||void 0===t||t.focus(),h.current.scrollTop=h.current.scrollHeight,setTimeout((function(){h.current.scrollTop+h.current.clientHeight!==h.current.scrollHeight&&(h.current.scrollTop=h.current.scrollHeight)}),100);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()()}),[s]),Object(a.jsxs)("div",{className:"chat__body",ref:b,id:"chatick",children:[(null===s||void 0===s?void 0:s._id)?Object(a.jsxs)("div",{className:"chat__main",children:[Object(a.jsxs)("div",{className:"chat__navbar",children:[Object(a.jsxs)("div",{className:"chat__navbar__left",children:[Object(a.jsx)(B.a,{src:null===(t=s[fe(f)])||void 0===t||null===(r=t.avatar)||void 0===r?void 0:r.path,className:"chat__navbar__avatar",icon:Object(a.jsx)(F.a,{})}),Object(a.jsxs)("div",{className:"chat__navbar__name",children:["\u041a\u043b\u0438\u0435\u043d\u0442 ",(null===(c=s.client)||void 0===c?void 0:c.num)||"-"]})]}),Object(a.jsx)(Ee.a,{className:Object(je.a)("chat__navbar__phone",{"chat__navbar__phone--close":!!d}),id:"phone-button",onClick:d?function(){return d.close()}:i})]}),Object(a.jsx)("div",{className:"chat__list",ref:h,id:"scrollableList",onScroll:L,children:g.map((function(e,t){return Object(a.jsxs)("div",{children:[Object(a.jsx)(Fe,{message:e}),H(e,t)&&Object(a.jsx)(Se.a,{children:Ce()(g[t+1].createdAt).format("DD.MM.YYYY")})]},e._id)}))}),Object(a.jsxs)("div",{className:"chat__inputs",children:[Object(a.jsx)(Me.a,{className:"chat__input-upload",onClick:function(){return O(!0)}}),Object(a.jsx)(ue.a,{ref:j,className:"chat__input-field",value:y,onChange:function(e){return C(e.target.value)},onPressEnter:function(){return D()}}),Object(a.jsx)(Ie.a,{className:"chat__input-send",onClick:function(){return D()}})]})]}):Object(a.jsx)("div",{className:"chat__select-chat",children:Object(a.jsx)("div",{className:"chat__select-chat-text",children:"\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0447\u0430\u0442"})}),Object(a.jsx)(He,{isVisible:v,onClose:function(){return O(!1)},onOk:$})]})};function Ue(e,t){e.srcObject=t,e.addEventListener("loadedmetadata",(function(){e.play()}))}var Pe=function(){var e=Object(b.h)().search,t=Object(n.useRef)(null),r=I((function(e){return e.user.user})),c=I((function(e){return e.core.peer})),s=Object(n.useState)([]),i=Object(l.a)(s,2),d=i[0],j=i[1],h=Object(n.useState)({}),m=Object(l.a)(h,2),p=m[0],v=m[1],O=Object(n.useState)(null),x=Object(l.a)(O,2),_=x[0],g=x[1],w=Object(n.useState)(!1),N=Object(l.a)(w,2),k=N[0],y=N[1],C=function(){var e=Object(u.a)(o.a.mark((function e(){var a,n,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===p||void 0===p?void 0:p._id){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({audio:!0});case 4:a=e.sent,n=["operator","admin"].includes(r.role)?p.client._id:p.operator._id,(s=c.call(n,a)).on("stream",(function(e){Ue(t.current,e),g(s)})),s.on("close",(function(){console.log("caller onclose"),g(null),y(!1)}));case 9:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return Object(n.useEffect)((function(){var e=function(){var e=Object(u.a)(o.a.mark((function e(r){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,re.service("users").get(r.peer);case 2:a=e.sent,console.log("call",r,a,r.peer),we.a.confirm({title:"\u041a\u043b\u0438\u0435\u043d\u0442 ".concat(a.num," \u0432\u0430\u043c \u0437\u0432\u043e\u043d\u0438\u0442, \u043e\u0442\u0432\u0435\u0442\u0438\u0442\u044c?"),centered:!0,okText:"\u0414\u0430",cancelText:"\u041d\u0435\u0442",onOk:function(){var e=Object(u.a)(o.a.mark((function e(){var a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.getUserMedia({audio:!0});case 2:a=e.sent,r.answer(a),y(!0),g(r),r.on("stream",(function(e){Ue(t.current,e)})),r.on("close",(function(){console.info("callee onclose"),g(null),y(!1)}));case 8:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),onCancel:function(){r.close()}});case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();c.on("call",e);var r=function(){console.log("zaclousil")};return c.on("close",r),function(){c.off("call",e),c.off("close",r)}}),[c,p,_]),Object(n.useEffect)((function(){"client"===ge.a.parse(e).from&&"client"===r.role&&function(){var e=Object(u.a)(o.a.mark((function e(){var t,a,n,c,s;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,re.service("users").find({query:{role:"operator",isOnline:!0,isBusy:!1}});case 2:if(t=e.sent,0!==(a=t.data).length){e.next=6;break}return e.abrupt("return");case 6:return i=0,o=a.length-1,n=Math.round(Math.random()*(o-i)+i),c=a[n],console.log("conect",a,c,r),e.prev=9,e.next=12,re.service("chats").create({clientId:r._id,operatorId:c._id});case 12:s=e.sent,v(s),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(9),console.error("Error while creating chat",e.t0);case 19:case"end":return e.stop()}var i,o}),e,null,[[9,16]])})));return function(){return e.apply(this,arguments)}}()()}),[e]),Object(n.useEffect)((function(){var e=function(e){console.log("created chat",e),j((function(t){return[e].concat(Object(xe.a)(t))}))},t=function(e){console.log("patched chat",e);var t=d.map((function(t){return t._id===e._id?Object(f.a)(Object(f.a)({},e),{},Object(ie.a)({},me(r),p._id===e._id?0:function(e,t){return e[t.role+"UnreadMessages"]}(e,r))):t}));j(t)};return re.service("chats").on("created",e),re.service("chats").on("patched",t),function(){re.service("chats").removeListener("created",e),re.service("chats").removeListener("patched",t)}}),[d,p._id,r]),Object(a.jsxs)("div",{className:"chat",children:[Object(a.jsx)("audio",{ref:t}),Object(a.jsx)(Ae,{chats:d,activeChat:p,setChats:j,onChatClick:function(e){var t=d.map((function(t){return t._id===e._id?Object(f.a)(Object(f.a)({},e),{},Object(ie.a)({},me(r),0)):t}));j(t),v(e)}}),Object(a.jsx)(Re,{activeChat:p,onCallUser:C,isCallActive:k,currentCall:_})]})},ze=function(){return Object(a.jsxs)("div",{className:"notfound",children:[Object(a.jsx)("h2",{children:"404"}),Object(a.jsx)("p",{children:"\u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b \u043d\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442"})]})},qe=r(207),Be=r.n(qe),Ye=function(){return function(){var e=Object(u.a)(o.a.mark((function e(t,r){var a,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((a=r().user.user)&&a._id){e.next=3;break}return e.abrupt("return");case 3:return n=new Be.a(a._id,{host:"3.67.189.159",port:80,path:"/api/peerjs"}),t(g(n)),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()},Je=function(e){var t={};return e.email||(t.email="\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0435 \u043f\u043e\u043b\u0435"),e.email&&!be(e.email)&&(t.email="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 email \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e"),(!e.password||e.password.trim().length<=6)&&(t.password="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043d\u0435 \u043c\u0435\u043d\u0435\u0435 6 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432"),t},Ve=function(){var e=Object(b.g)(),t=D(),r=I((function(e){return e.user})).isAuth,c=function(){var r=Object(u.a)(o.a.mark((function r(a){return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,t(ae({email:a.email,password:a.password}));case 3:t(Ye()),e.push("/chat"),r.next=10;break;case 7:return r.prev=7,r.t0=r.catch(0),r.abrupt("return",Object(ie.a)({},de.a,r.t0.message));case 10:case"end":return r.stop()}}),r,null,[[0,7]])})));return function(e){return r.apply(this,arguments)}}();return Object(n.useEffect)((function(){r&&e.push("/")}),[]),Object(a.jsx)("div",{className:"auth-form",children:Object(a.jsx)(oe.b,{onSubmit:c,validate:Je,render:function(e){var t=e.handleSubmit,r=e.submitError,n=e.submitting;return Object(a.jsxs)("form",{className:"auth-form auth-form--login",onSubmit:t,children:[Object(a.jsx)("div",{className:"auth-form__title",children:"\u0412\u0445\u043e\u0434"}),r&&Object(a.jsx)("div",{className:"auth-form__error",children:r}),Object(a.jsxs)("div",{className:"auth-form__fields",children:[Object(a.jsx)(oe.a,{name:"email",children:function(e){var t=e.input,r=e.meta;return Object(a.jsx)(he,{meta:r,errorText:r.error,children:Object(a.jsx)(ue.a,Object(f.a)(Object(f.a)({},t),{},{placeholder:"Email"}))})}}),Object(a.jsx)(oe.a,{name:"password",children:function(e){var t=e.input,r=e.meta;return Object(a.jsx)(he,{meta:r,errorText:r.error,children:Object(a.jsx)(ue.a.Password,Object(f.a)(Object(f.a)({},t),{},{placeholder:"\u041f\u0430\u0440\u043e\u043b\u044c"}))})}})]}),Object(a.jsx)(le.a,{className:"auth-form__button",type:"primary",htmlType:"submit",loading:n,children:"\u0412\u043e\u0439\u0442\u0438"}),Object(a.jsxs)("div",{className:"auth-form__footer-text",children:["\u0412\u0441\u0435 \u0435\u0449\u0451 \u043d\u0435\u0442 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430? ",Object(a.jsx)(h.b,{to:"/signup",children:"\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c\u0441\u044f"})]})]})}})})},We=function(){return Object(a.jsx)(h.a,{children:Object(a.jsxs)(b.d,{children:[Object(a.jsx)(b.a,{exact:!0,path:"/",to:"/chat"}),Object(a.jsx)(H,{exact:!0,path:"/404",component:ze}),Object(a.jsx)(H,{exact:!0,path:"/login",component:Ve,layout:se}),Object(a.jsx)(H,{exact:!0,path:"/signup",component:ve,layout:se}),Object(a.jsx)(H,{exact:!0,path:"/chat",component:Pe,layout:ce,isProtected:!0}),Object(a.jsx)(H,{exact:!0,path:"/admin",component:Oe,layout:ce,isProtected:!0,allowedRoles:["admin"]}),Object(a.jsx)(b.a,{to:"/404"})]})})};r(367),r(368);var Ze=function(){var e=Object(n.useState)(!0),t=Object(l.a)(e,2),r=t[0],c=t[1];return Object(n.useEffect)((function(){(function(){var e=Object(u.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,L.dispatch(function(){var e=Object(u.a)(o.a.mark((function e(t){var r,a,n;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,re.reAuthenticate();case 2:return r=e.sent,a=r.accessToken,n=r.user,t(C({isAuth:!0,token:a,user:n})),e.abrupt("return",n);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:L.dispatch(Ye()),e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),console.error("WHAT THE HELL YOU ARE NOT AUTHENTICATed",e.t0);case 9:return e.prev=9,c(!1),e.finish(9);case 12:case"end":return e.stop()}}),e,null,[[0,6,9,12]])})));return function(){return e.apply(this,arguments)}})()()}),[]),r?Object(a.jsx)("div",{className:"page-loading",children:Object(a.jsx)(j.a,{type:"bars",color:"#69C262"})}):Object(a.jsx)(p.a,{store:L,children:Object(a.jsx)("div",{className:"App",children:Object(a.jsx)(We,{})})})},Ke=function(e){e&&e instanceof Function&&r.e(3).then(r.bind(null,387)).then((function(t){var r=t.getCLS,a=t.getFID,n=t.getFCP,c=t.getLCP,s=t.getTTFB;r(e),a(e),n(e),c(e),s(e)}))};s.a.render(Object(a.jsx)(Ze,{}),document.getElementById("root")),Ke()}},[[369,1,2]]]);
//# sourceMappingURL=main.14a6e041.chunk.js.map